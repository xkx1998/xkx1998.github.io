---
layout:     post
title:      Redis主从复制
subtitle:   
date:       2019-6-3
author:     BY 许可翔
header-img: img/charlotte/b2f68e7ebd6314a8358661a765ca9095527eeee1.jpg
catalog: true
tags:
    - Typora
---
## Redis主从复制的实现原理(旧版和新版)
在Redis中，用户可以通过执行SLAVEOF命令或者配置slaveof <ip> <port>选项，让一个服务器去复制(replicate)
另一个服务器，我们称呼被复制的服务器为主服务器(master),而对服务器进行复制的服务器则被称为从服务器(slave),

### 旧版复制功能的实现(Redis 2.8之前)

**Redis的复制功能可以分为同步和命令传播两个操作：**
1. 同步操作用于将从服务器的数据库状态更新至主服务器当前所处的状态。

2. 命令传播操作则用于在主服务器的数据库状态被修改，导致主从服务器的数据库状态不一致时，让主从服务器的数据库重新回到一致状态。


#### 同步

当客户端向从服务器发送SLAVEOF命令，要求从服务器复制主服务器时，从服务器首先要执行同步操作，即将从服务器的数据库状态更新至主服务器当前所处的数据库状态。

同步过程步骤如下：

1. 从服务器向主服务器发送SYNC命令。

2. 收到SYNC命令的主服务器执行BGSAVE命令，在后台生成一个RDB文件，并使用一个缓冲区记录从现在开始执行的所有写命令。

3. 当主服务器的BGSAVE命令执行完毕，主服务器将生成的RDB文件发送给从服务器，从服务器接收并加载这个RDB文件，将自己的数据库状态更新至主服务器执行BGSAVE命令是的数据库状态。

4. 主服务器将记录在缓冲区里面的所有写命令发送给从服务器，从服务器执行这些写命令，将自己的数据库状态更新至主服务器当前所处的状态。

![](/img/1565320358(1).jpg)

![](/img/1565320413(1).jpg)

#### 命令传播

在同步操作完毕后，主从服务器两者的数据库状态达到一致，但是如果客户端发送写命令给主服务器时，将导致主从服务器状态不一致。
为了让主从服务器数据一致，主服务器需要对从服务器执行命令传播操作：主服务器会将自己执行的那条写命令，发送给从服务器执行，当从服务器执行了该写命令后，主从服务器将再次回到一致状态。

### 旧版复制功能的缺陷
在Redis中，从服务器对主服务器的复制可以分为以下两种情况：

1. 初次复制：从服务器以前没有复制过任何主服务器。或者上次复制的主服务器和这一次不是同一个主服务器。

2. 短线后重新复制：处于命令传播阶段的主服务器因为网络原因而中断复制，但从服务器通过自动重现连接上了主服务器，并继续复制主服务器。

![断线重连的例子](/img/1565320599(1).jpg)

**缺陷**

1. 主服务器在时间T0到T10086过程中一直处于一致状态。这两个服务器的数据是一样的。

2. 从服务器断开重连后，只需要主服务器的K10087，K10088，K10089三个命令即可，但是主服务器却返回了一个新的RDB文件，如果RDB文件很大，必将导致严重的内存问题。

![](/img/1565320710(1).jpg)

### 新版复制功能的实现2.8开始

1. **为了解决旧版的问题，Redis2.8以后引入了PSYNC代替SYNC命令执行复制时的同步操作。**

2. **PSYNC命令具有完全同步和部分重同步功能。**

3. **完全同步和旧版的同步是一样的。**

4. **部分重同步主要是用于断线后的重复制情况：当从服务器断开重新连接后，如果条件允许，主服务器将断开期间的写命令发给从服务器，从服务器执行断开期间的写命令完成同步，将数据库更新到和主服务器一致。**

![](/img/1565320919(1).jpg)


#### 部分重同步的实现

**三个重要的概念**
1. 主服务器的复制偏移量和从服务器的复制偏移量。

2. 主服务器的复制积压缓冲区（队列，默认1MB）。

3. 服务器的允许ID。

#### 复制偏移量

**执行复制的双方--主服务器和从服务器会分别维护一个复制偏移量**

1. 主服务器向从服务器发送N个字节的数据时，主服务器的复制偏移量会+N

2. 从服务器收到主服务器发送来的N个字节数据时，从服务器的复制偏移量也会+N

**通过比对主从服务器的复制偏移量可以判断出主从数据库是否是一致性状态

1. 主从服务器在一致性状态时，主从服务器的复制偏移量是相同地。

2. 主从复制偏移量不相等时，主从服务器的状态就不一致。

**当从服务器在断线重连的时候会发送一个PSYNC命令给主服务器，并且也会传播自己的
复制偏移量给主服务器，主服务器会根据复制偏移量来判断要执行部分重同步还是完整重同步。**


#### 复制积压缓冲区(队列)

**复制积压缓冲区是主服务器维护的一个固定长度的队列，默认大小为1MB**

当主服务器进行命令传播的时候，它不仅会把写命令发送给所有的从服务器，它还会将写命令写入
复制积压缓冲区中。

![](/img/1565328704(1).jpg)

主服务器中的复制积压缓冲区中会保存一部分最近执行的写命令，并且复制积压缓冲区会在队列为每个
字节记录它所对应的复制偏移量。

![](/img/1565329130(1).jpg)

当从服务器断开后重连上主服务器时，从服务器会发送一个PSYNC命令将自己的复制偏移量offset发送给
主服务器，主服务器根据从服务器的复制偏移量来判断对从服务器的做何种同步操作

1. 如果从服务器的复制偏移量之后的数据(也就是offset+1开始以后的数据)还存在在复制积压缓冲区中，
那么就对从服务器做部分重同步的操作。

2. 相反，如果从服务器的复制偏移量以后的数据不存在在复制积压缓冲区中，那么就相当于发送了一个SYNC命令，
就对从服务器做完整重同步的操作。

**复制积压缓冲区的大小**

![](/img/1565329588(1).jpg)


#### 服务器运行ID

除了复制偏移量和复制积压缓冲区之外，实现部分重同步还需要用到服务器运行ID

1. 每个服务器，不管主服务器还是从服务器都有运行ID，可通过info server查看run_id

2. 每个服务器运行ID是由40个随机的十六进制字符组成。

3. 建立主从关系时，主节点会将自己的run_id发送给从节点，从节点保存该ID，在断线重连时从节点将该ID发送给主节点。

4. 断线重连的时候，主服务器会根据从服务器发送来的run_id和自己的run_id进行比较，来判断执行哪种同步，
如果相等，则尝试进行部分重同步(具体能否部分复制还要看offset和复制积压缓冲区情况)。如果不相等，则进行完整重同步。

### PSYNC命令的实现

![](/img/1565330221(1).jpg)

### 复制的实现

#### 步骤1：设置主服务器的地址和端口
127.0.0.1:12345> SLAVEOF 127.0.0.1 6379

从服务器首先要做的是将客户端给定的主服务器的IP和端口设置保存到
服务器状态的masterhost属性和masterport属性里面：

```java
struct redisServer{
    //...
    //主服务器ip地址
    char *masterhost;
    
    //主服务器端口
    char *masterport;
    //..
}
```

#### 步骤2：建立套接字连接

![](/img/1565330781(1).jpg)


#### 步骤3：发送PING命令

从服务器成为主服务器的客户端后，做的第一件事就是向主服务器发送一个PING命令

![](/img/1565330918(1).jpg)

**两个作用**

1. 检查套接字的读写状态是否正常，就是检查网络连接状态。

2. 通过发送PING命令可以检查主服务器能否正常处理命令请求。

从服务器在发送PING命令之后将遇到以下三种情况中的一种

1. 主服务器的命令恢复不能再有效的时间内传播到从服务器，说明网络连接的状态不佳，
则需要断开连接，从服务器重新创建套接字连向主服务器。

2. 如果主服务器向从服务器发送了一个错误，表示主服务器暂时没有办法处理从服务器的请求。
不能继续复制的后续操作。遇到这种情况，从服务器需要断开并重新创建套接字连向主服务器的套接字。

3. 如果从服务器收到"PONG"回复，说明网络连接状态好，而且主服务器能正常处理从服务器的请求，
可以进行后续的复制操作。

![](/img/1565331690.jpg)

#### 步骤4：身份验证

从服务器在收到主服务器返回的""PONG"后，下一步决定是否要进行身份验证。

1. 如果从服务器设置了masterauth选项，那么进行身份验证

2. 如果从服务器没有设置了masterauth选项，那么不进行身份验证。

![](/img/1565331901(1).jpg)

![](/img/1565331952(1).jpg)

#### 步骤5：发送监听端口号

![](/img/1565332051(1).jpg)

#### 步骤6：同步

#### 步骤7：命令传播

### 心跳检测
**三个作用**

1. 检测主从服务器的网络连接状态

2. 辅助实现min-slaves配置选项

3. 检测命令丢失